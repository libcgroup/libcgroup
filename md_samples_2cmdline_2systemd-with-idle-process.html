<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libcgroup: systemd-with-idle-process</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libcgroup
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">systemd-with-idle-process</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>SPDX-License-Identifier: LGPL-2.1-only</em></p>
<p><em>Copyright (c) 2023 Oracle and/or its affiliates.</em></p>
<p>_Author: Tom Hromatka &lt;<a href="#" onclick="location.href='mai'+'lto:'+'tom'+'.h'+'rom'+'at'+'ka@'+'or'+'acl'+'e.'+'com'; return false;">tom.h<span class="obfuscator">.nosp@m.</span>roma<span class="obfuscator">.nosp@m.</span>tka@o<span class="obfuscator">.nosp@m.</span>racl<span class="obfuscator">.nosp@m.</span>e.com</a>&gt;_</p>
<h1><a class="anchor" id="autotoc_md26"></a>
Creating a Systemd Scope and Child Hierarchy via Libcgroup Command Line</h1>
<p>The goal of this document is to outline the steps required to create a systemd scope and a child cgroup hierarchy using the libcgroup command line tools.</p>
<p>The following steps are encapsulated in a <a href="../c/create_systemd_scope.c">C example</a> using the libcgroup C APIs.</p>
<p>The following steps are encapsulated in a <a href="../../tests/ftests/086-sudo-systemd_cmdline_example.py">libcgroup automated test</a>.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
Requirements:</h2>
<ol type="1">
<li>Create a cgroup hierarchy that obeys the <a href="https://systemd.io/CGROUP_DELEGATION/">single-writer rule</a></li>
</ol>
<ol type="1">
<li>The hierarchy should be cgroup v2</li>
</ol>
<ol type="1">
<li>The hierarchy should be of the form <div class="fragment"><div class="line">database.scope</div>
<div class="line">├── high-priority</div>
<div class="line">├── low-priority</div>
<div class="line">└── medium-priority</div>
</div><!-- fragment --></li>
</ol>
<ol type="1">
<li>The memory controller should be enabled for the entire tree<ol type="a">
<li>The <code>high-priority</code> cgroup should be guaranteed at least 1GB of RAM</li>
</ol>
<ol type="a">
<li>The <code>low-priority</code> cgroup should be hard-limited to 2GB of RAM</li>
</ol>
<ol type="a">
<li>The <code>medium-prioirty</code> cgroup should have a soft memory limit of 3 GB</li>
</ol>
</li>
</ol>
<ol type="1">
<li>The cpu controller should be enabled for the entire tree<ol type="a">
<li>The <code>high-priority</code> cgroup should be able to consume 60% of CPU cycles</li>
</ol>
<ol type="a">
<li>The <code>medium-priority</code> cgroup should be able to consume 30% of CPU cycles</li>
</ol>
<ol type="a">
<li>The <code>low-priority</code> cgroup should be able to consume 10% of CPU cycles</li>
</ol>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md28"></a>
Steps</h2>
<ol type="1">
<li><p class="startli">Create a delegated <a href="https://www.freedesktop.org/software/systemd/man/systemd.scope.html">scope</a> cgroup </p><div class="fragment"><div class="line">sudo cgcreate -c -S -g cpu,memory:mycompany.slice/database.scope</div>
</div><!-- fragment --><p class="startli">This will create a <a href="https://github.com/systemd/systemd/blob/main/docs/TRANSIENT-SETTINGS.md">transient</a>, <a href="https://systemd.io/CGROUP_DELEGATION/">delegated</a> scope. The <code>-c</code> flag instructs libcgroup to create a systemd scope; libcgroup then instructs systemd that this hierarchy is delegated, i.e. it is to be managed by another process and <em>not</em> by systemd. The <code>-S</code> flag notifies libcgroup that we want <code>mycompany.scope/database.slice</code> to be the default base path in libcgroup; this will significantly help in reducing typing in follow-on commands. The <code>-g</code> flag tells libcgroup to create a cgroup named <code>mycompany.slice/database.scope</code> and enable the cpu and memory controllers within it.</p>
<details >
<summary >
Problems during this step?</summary>
<p></p>
<p>Systemd should automatically remove scopes with no active processes running within them. So, the first step would be to kill any processes in the scope, wait to see if systemd removes the scope, and then try the <code>cgcreate</code> operation again.</p><ul>
<li><p class="startli">Remove all processes in the scope <code> $ for PID in $(cgget -nvb -r cgroup.procs mycompany.slice/database.scope); do sudo kill -9 $PID;done </code></p>
<p class="startli">The above command could be simplified as <code>for PID in $(cgget -nv -r cgroup.procs /); do sudo kill -9 $PID;done</code>, but introduces some risk. If there is a typo or the default scope path isn't set, then unconditionally killing processes in <code>/</code> could be catastrophic.</p>
</li>
</ul>
<p>Sometimes systemd's internal list of scopes gets out of sync with the filesystem. You can purge the <code>database.scope</code> from its list by running the following commands</p><ul>
<li>Remove <code>database.scope</code> from systemd's internal list <code> sudo systemctl kill database.scope sudo systemctl stop database.scope </code> </li>
</ul>
</details>
</li>
</ol>
<ol type="1">
<li><p class="startli">Create the child cgroups </p><div class="fragment"><div class="line">$ sudo cgcreate -g cpu,memory:mycompany.slice/database.scope/high-priority</div>
<div class="line">cgcreate: can&#39;t create cgroup mycompany.slice/database.scope/high-priority: Operation not supported</div>
</div><!-- fragment --><p class="startli">But... but... I did everything right. Why can't I create the <code>high-priority</code> child cgroup? This operation failed due to the <a href="https://systemd.io/CGROUP_DELEGATION/">no-processes-in-inner-nodes</a> rule. Since a process, <code>libcgroup_systemd_idle_thread</code>, resides in <code>database.scope</code>, we are subject to the no-process-in-inner-nodes rule. The kernel will let us create a child cgroup, but it will fail when we try to enable controllers in <code>database.scope</code>'s <code>cgroup.subtree_control</code> file. There are a few different ways to solve this failure; the easiest is probably to create a temporary cgroup under <code>database.scope</code> and move the <code>libcgroup_systemd_idle_thread</code> to this temporary cgroup. This allows <code>database.scope</code> to operate as a legal inner node, and we can then create the entire hierarchy.</p><ol type="a">
<li><p class="startli">Temporarily disable the cpu and memory controllers at the scope level </p><div class="fragment"><div class="line">sudo cgset -r cgroup.subtree_control=&quot;-cpu -memory&quot; /</div>
</div><!-- fragment --><p class="startli">Since we informed libcgroup that <code>mycompany.slice/database.scope</code> is the default path, we can use <code>/</code>. Otherwise, we would have had to specify the entire path. This pattern continues throughout this example.</p>
</li>
</ol>
<ol type="a">
<li>Create a temporary cgroup and move the idle process <code> sudo cgcreate -g :tmp sudo cgclassify -g :tmp $(cgget -nv -r cgroup.procs /) </code></li>
</ol>
<ol type="a">
<li>Re-enable the cpu and memory controllers at the scope level <code> sudo cgset -r cgroup.subtree_control="+cpu +memory" / </code></li>
</ol>
<p class="startli">Now we can finally get back to creating our child cgroups </p><div class="fragment"><div class="line">sudo cgcreate -g cpu,memory:high-priority -g cpu,memory:medium-priority -g cpu,memory:low-priority</div>
</div><!-- fragment --></li>
</ol>
<ol type="1">
<li>Configure the cgroups per the requirements<ol type="a">
<li>The <code>high-priority</code> cgroup should be guaranteed at least 1GB of RAM <div class="fragment"><div class="line">sudo cgset -r memory.low=1G high-priority</div>
</div><!-- fragment --></li>
</ol>
<ol type="a">
<li>The <code>low-priority</code> cgroup should be hard-limited to 2GB of RAM <code> sudo cgset -r memory.max=2G low-priority </code></li>
</ol>
<ol type="a">
<li>The <code>medium-prioirty</code> cgroup should have a soft memory limit of 3 GB <code> sudo cgset -r memory.high=3G medium-priority </code></li>
</ol>
<ol type="a">
<li><p class="startli">The <code>high-priority</code> cgroup should be able to consume 60% of CPU cycles <code> sudo cgset -r cpu.weight=600 high-priority </code></p>
<p class="startli">Note that I've (somewhat arbitrarily) chosen a total <code>cpu.weight</code> within <code>database.scope</code> to be 1000. Thus, to meet the 60% requirement, we need to allocate 600 shares to the <code>high-priority</code> cgroup.</p>
</li>
</ol>
<ol type="a">
<li>The <code>medium-priority</code> cgroup should be able to consume 30% of CPU cycles <code> sudo cgset -r cpu.weight=300 medium-priority </code></li>
</ol>
<ol type="a">
<li>The <code>low-priority</code> cgroup should be able to consume 10% of CPU cycles <code> sudo cgset -r cpu.weight=100 low-priority </code></li>
</ol>
</li>
</ol>
<ol type="1">
<li>Start up the application<ul>
<li>If the application is already running, then you can use <code>cgclassify</code> to move the process(es) to the appropriate cgroups</li>
<li>To start a fresh application, it is recommended to use <code>cgexec</code> to place the application in the desired cgroup</li>
<li>Finally, consider using <code>cgrulesengd</code> to automatically move processes to the correct cgroups</li>
</ul>
</li>
</ol>
<ol type="1">
<li>Clean up<ol type="a">
<li>Now that there are other processes running within the scope, we can remove the <code>libcgroup_systemd_idle_thread</code> <div class="fragment"><div class="line">$ for PID in $(cgget -nv -r cgroup.procs tmp); do sudo kill -9 $PID;done</div>
</div><!-- fragment --></li>
</ol>
<ol type="a">
<li>Delete the <code>tmp</code> cgroup <code> sudo cgdelete -g :tmp </code></li>
</ol>
</li>
</ol>
<ol type="1">
<li>Verify the cgroups were configured per the requirements <div class="fragment"><div class="line">$ cgget -r cpu.weight -r memory.low -r memory.high -r memory.max high-priority medium-priority low-priority</div>
<div class="line">high-priority:</div>
<div class="line">cpu.weight: 600</div>
<div class="line">memory.low: 1073741824</div>
<div class="line">memory.high: max</div>
<div class="line">memory.max: max</div>
<div class="line"> </div>
<div class="line">medium-priority:</div>
<div class="line">cpu.weight: 300</div>
<div class="line">memory.low: 0</div>
<div class="line">memory.high: 3221225472</div>
<div class="line">memory.max: max</div>
<div class="line"> </div>
<div class="line">low-priority:</div>
<div class="line">cpu.weight: 100</div>
<div class="line">memory.low: 0</div>
<div class="line">memory.high: max</div>
<div class="line">memory.max: 2147483648</div>
</div><!-- fragment --></li>
</ol>
<ol type="1">
<li>Summary</li>
</ol>
<p>This document outlines the steps for creating a delegated systemd scope and configuring its child cgroups on a cgroup v2 system. Systemd and libcgroup provide powerful tools to simplify these steps. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
